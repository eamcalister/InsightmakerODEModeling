<?xml version='1.0' encoding='utf-8'?>

<section xmlns:xi="http://www.w3.org/2001/XInclude" xml:id="SprintModel">
	<title>Modeling a Sprint with Insightmaker</title>

  <objectives>
		<ul>
	  		<li>
	  			<p>
					Create a one-parameter ODE model of the velocity and position of a sprinter.
	  			</p>
	  		</li>
			<li>
				<p>
					Compare the results of our model to real-world data from the 2008 Olympic 100m dash. 	
				</p>
			</li>
			<li>
				<p>
					Estimate the value of the parameter in our ODE model that yields the best fit to the data using the built-in optimization abilities of Insightmaker.	
				</p>
			</li>
	  	</ul>
  </objectives>

<introduction>
	<p>
		In this section we will follow the example given in the first section <xref ref="SIMIODE-text"/> and <xref ref="BoltSprint"/> to show the full workflow of modeling a real-world scenario with Insightmaker. You are encouraged to build your own Insights as you work through this section. However, if you get stuck, links to three Insights are provided at the end of this section. Each one illustrates a different approach to parameter estimation.
	</p>

<p>
	We consider the problem of creating an ODE model for the velocity of a sprinter based on the following data from the 2008 Olympic 100m dash:
</p>

<table xml:id="sprint_data"><title>Usain Bolt's Position Data from the 2008 Olympic 100m Dash</title>
<tabular>
	<row bottom = "major">
		<cell>Time (s)</cell> <cell>0.165</cell> <cell>1.85</cell> <cell>2.87</cell> <cell>3.78</cell> <cell>4.65</cell> <cell>5.50</cell> <cell>6.32</cell> <cell>7.14</cell> <cell>7.96</cell> <cell>8.79</cell> <cell>9.69</cell>
	</row>
	<row>
		<cell>Position (m)</cell> <cell>0</cell> <cell>10</cell> <cell>20</cell> <cell>30</cell> <cell>40</cell> <cell>50</cell> <cell>60</cell> <cell>70</cell> <cell>80</cell> <cell>90</cell> <cell>100</cell>
	</row>
</tabular>
</table>

<p>
	Observe that the data we are presented with is position, while we are attemting to model velocity. This turns out to be a common situation as velocity is easier to model with a differential equation using Newton's Second Law (<m> F = ma</m> has the derivative of velocity on the right-hand side), whereas position is easier to measure for data collection. However, since we can numerically integrate using Insightmaker we just need to create a model for velocity, then make the velocity stock equal to the inflow rate of the position stock via a link. This idea is illustrated with the following basic diagram, which we may refer to as an <term>idiom</term> since it describes a very common modeling situation (this is the velocity-to-position idiom).
</p>

<figure xml:id="velocity_to_position">
	<caption>The basic velocity to position diagram.</caption>
	<image source="images/velocity_to_position.png" width="80%"></image>
</figure>

<p>
	Creating this basic diagram for the modeling scenario, while it may seem intuitive, is the first step in the process of modeling using Insightmaker. We will now carry out the rest of the modeling process explicitly.
</p>
</introduction>

<subsection><title>Creating the Model Diagram</title>

<axiom xml:id="modeling-step-one"><title>Step 1: Identify Stocks and Flow Relationships</title>
	<statement>
		<p>
			Identify all time-dependent variables (stocks) in the scenario and observe possible inflows, outflow, and flows between stocks. Decide if any stock influences the flow into or out of another and create links accordingly. 
		</p>
	</statement>
</axiom>

<p>
	It is also good practice to establish units on all the stocks and flows of the model at this stage. In this case we will establish meters as the units of position, m/s as the units of velocity (the stock and the flow into position) and m/s<m>^2</m> as the units of both flows into velocity.
</p>



</subsection>

<subsection><title>Establish Settings and Create Formulas</title>


<axiom xml:id="modeling-step-two"><title>Step 2: Establish Flow Formulas and Parameters</title>
	<statement>
		<p>
			Create formulas for the flow rates as well as any parameters (variables in Insightmaker) that the flow rates may depend on.
		</p>
	</statement>
</axiom>

<p>
For the model of a sprint we will follow the Hill-Keller model as in <xref ref="BoltSprint"/>. In this model we have one term for propulsive force, <m>F_p</m>, which is assumed to be proportional to the mass of the sprinter. Thus,
<me>
	F_p = mP.
</me>
Here <m>F</m> will be in units of  m/s<m>^2</m> and <m>m</m> will be in units of kilograms. We will see that only one of them (<m>F</m>) must be added as a variable in the model.
</p>
<exercise>
	<statement>
	<p>
	How realistic does it seem that the propulsive force generated by a sprinter is 
	</p>
	<ol>
		<li>
			<p>
				proportional to their mass and
			</p>
		</li>
		<li>
			<p>
				constant with respect to time?
			</p>
		</li>
	</ol> 
	</statement>
</exercise>
<p>
	There is also a resistive force, <m>F_r</m>, that is assumed to be proportional to the velocity <em>and</em> the mass of the sprinter. This assumption is based on the idea that this resistive force accounts for air resistance and internal resistance of the runner's body. Thus,
	<me>
		F_r = -kmv.
	</me>
	Here <m>k</m> has units of <m>1/</m>s. We will add <m>k</m> as a variable to our insight.
</p>
<p>
	Using Newton's Second Law, we have
	<me>
		mv' = mF-kmv.
	</me>
	Dividing everything by <m>m</m>, we now have formulas for our flows for the velocity position stocks:
	<table>
		<title>Flow Formulas for Sprint Model</title>
		<tabular>
			<row header="yes" bottom="medium">
				<cell>Flow</cell><cell>Formula</cell><cell>into/out of what</cell>
			</row>
			<row>
				<cell>acceleration terms</cell><cell>P</cell><cell>into velocity</cell>
			</row>
			<row>
				<cell>deceleration terms</cell><cell>kv</cell><cell>out of velocity</cell>
			</row>
			<row>
				<cell>velocity</cell><cell>v</cell><cell>into position</cell>
			</row>
		</tabular>
	</table>
</p>
<p>
	Our Insight so far should look like the figure below with the flows describe above.
</p>	
	<figure xml:id="sprint_model_1">
		<caption>The basic Hill-Keller Insight.</caption>
		<image source="images/HillKeller1.png" width="80%"></image>
	</figure>
<p>
	Simulation settings will be as follows:
	<dl>
		<li><title>Simulation Start:</title>
			<p>
				<m>0.0165</m>. This is the first time value in our data. It isn't zero because reaction time was nonzero.
			</p>
		</li>
		<li><title>Simulation End:</title>
			<p>
				<m>9.6735</m>. This is the difference between <m>9.69</m> and <m>0.0165</m>	
			</p>
		</li>
		<li><title>Time Units:</title>
			<p>
			Seconds	
			</p>
		</li>
		<li><title>Simulation Time Step:</title>
			<p>
			<m>0.0005</m>. This is a very small time step, but it is (sort of) necessary because of the initial point and wanting <m>9.69</m> to be an exact time step. (We could use a larger time step by investigating factors of <m>96735</m>.)	
			</p>
		</li>
		<li><title>Simulation Algorithm:</title>
			<p>
				Euler's Method. Since the time step is very small, Euler's Method will be accurate enough. 
			</p>
		</li>
	</dl>
</p>
<p>
	At this point we have the Insight. Following <xref ref="SIMIODE-text"/>, we will let <m>P = 11</m> and make <m>k</m> have a slider to adjust it in small steps (of size <m>.001</m>) between <m>0</m> and <m>1</m> (arrived at by running the model to see what works). 
</p>

</subsection>

<subsection><title>Using Data</title>


<axiom xml:id="modeling-step-three"><title>Step 3: Adjust Parameters to Match the Data</title>
	<statement>
		<p>
			After creating some quantifiable way of measuring how well the simulation matches the data, import the data as a converter and use an optimization procedure to make the simulation match the data as well as possible.
		</p>
	</statement>
</axiom>

<p>
In order of increasing complexity we can
<ol>
	<li>
		<p>
			adjust sliders to make the data match at one or more points by inspection,
		</p>
	</li>
	<li>
		<p>
			use the built-in optimization algorithm in Insightmaker to minimize the absolute value of the difference between one data point and the simulation, or
		</p>
	</li>
	<li>
		<p>
			use the built-in optimization algorithm in Insightmaker to minimize the sum of squared errors between the collection of data points and the simulation.
		</p>
	</li>
</ol>
</p>

<p>
	We will now demonstrate each of these for our sprint model and see how much variation we get in our value of <m>k</m> depending on the method.
</p>

<ol>
	<li>
		<p>
			<term>Adjust Paramteters with Sliders:</term> This is the most intuitive method. In this case, Bolt ran <m>100</m> meters in <m>9.69</m> seconds. Thus, we can run the simulation set to display time and position in the table display. Then, with sliders linked, we can adjust <m>k</m> to make the position as close as we can to <m>100</m> as possible when <m>t=9.69</m>. The result is shown below:
		</p>
		<figure xml:id="sprint_slider_pic">
			<image source="images/SprintSlider.png">
			</image>
			<caption>The slider of <m>0.948</m> for <m>k</m> yields a position very close to <m>100</m> meters.</caption>
		</figure>
	</li>
	<li>
		<p>
			<term>Use the Optimizer (Version 1):</term> As an alternative to using a slider, we can use the built in optimization algorithm to minimize <m>|\text{position}-100|</m> when <m>t=9.69</m>. First, we create a variable for <m>|\text{position}-100|</m> (it will need a link from position). Then we proceed as follows:
			<ul>
				<li>
					<p>
						Choose "Optimization and Goal Seeking" from the "Tools" (toolbox next to the "Simulate" button). 
					</p>
				</li>
				<li>
					<p>
						Choose <m>k</m> as the "primitive to adjust".
					</p>
				</li>
				<li>
					<p>
						Highlight "minimize" and "final value".
					</p>
				</li>
				<li>
					<p>
						Choose <m>|\text{position}-100|</m> as the primitive and accuracy of <m>0.001</m> along with a guess range for <m>k</m>. 
					</p>
				</li>
			</ul>
			Running the optimization, we find the <m>k</m> is about what we found using the slider method. Notice we get a range of values and the value of the minimized variable. This is a numerical optimization algorithm, hence may not arrive at exact values even if you can find them by hand. The output is shown below.
		</p>
		<figure xml:id="sprint_end_opt_pic">
			<image source="images/SprintEndValueOpt.png">
			</image>
			<caption>The optimizer also finds <m>k\approx 0.948</m>.</caption>
		</figure>
	</li>
	<li>
		<p>
			<term>Use the Optimizer (Version 2):</term> Minimizing the difference between <m>100</m> and the model's predictied position at <m>t=9.69</m> does not account for any other time-position pairs. To obtain a more global fit to the data, we will use a <em>converter</em> with the entire dataset. Then we will minimize the sum of squared errors from the data to the model outputs.
		</p>
		<p>
			<sidebyside widths="35% 5% 60%" margins="auto" valign="top">
				<p>	
				To proceed, click to add a primitive and choose "Add Converter". Call your converter "data".
				</p><p></p>
				<image source="images/add_converter.png" width="60%"></image>
				</sidebyside>
		</p>
		<p>
			From here, insert the time and position values from <xref ref="sprint_data"/> with time as input source, meters as units, and linear interpolation. (Linear interpolation builds additional data points for comparison to the simulation by drawing straight lines through the data points.) 
		</p>
		<p>
			Now create a new variable called <m>SE</m> (for "squared error") that has <m>\text({position}-\text{data})^2</m> as its formula and m<m>^2</m> as units.
		</p>
		<p>
			Now open the optimization menu and choose to adjust <m>k</m> to minimize the integral of <m>SE</m>. (The integral will be the sum of the squared errors.)
		</p>
		<p>
			Running the optimization, we find that this method gives <m>k\approx 0.956</m>.
		</p>
		<figure xml:id="sprint_sse_opt_pic">
			<image source="images/SprintSSEOpt.png">
			</image>
			<caption>The optimizer now finds <m>k\approx 0.956</m> with the sum (integral) of the squared errors equal to <m>23202.05</m>.</caption>
		</figure>
	</li>
</ol>

<exercise>
	<statement>
		<p>
			Create a new stock whose flow rate is <m>SE/\text{TimeStep()}</m> (dividing by <m>\text{TimeStep()}</m> will make this into a <em>sum</em> rather than an integral, which is what the optimizer does, really). Use this to compare the <m>SSE</m> for <m>k=0.948</m> and <m>k=0.956</m> to verify that the latter gives a better global fit to the data.
		</p>
	</statement>
</exercise>

</subsection>

<subsection xml:id="sprint_insights">
	<title>Sprint Insights</title>
	<p>
		For comparison to your Insights, see below:
		<ul>
			<li>
				<p>
					<url href="https://insightmaker.com/insight/1xXXnmxofSpDcIMFZgByMg" > Insight only adjusting slider to match data.</url>
				</p>
			</li>
			<li>
				<p>
					<url href="https://insightmaker.com/insight/58F5qZ0Fmgj8xhsumaE6WC" >Insight using the optimizer to match position when <m>t=9.69</m>.</url>
				</p>
			</li>
			<li>
				<p>
					<url href="https://insightmaker.com/insight/sJBZBRU4byVeBcQIfublD" >Insight using the optimizer to minimize the sum of the squared errors.</url>
				</p>
			</li>
		</ul>
	</p>
	
	
	
</subsection>

</section>
